name: Refresh Data and Publish

on:
  push:
    paths-ignore:
    # Changes to docs are autogenerated by this workflow
    - 'docs/**'
    - 'README.md'
  schedule:
    - cron:  '0 0 * * 6'

jobs:
  refreshAndPublish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v2

    - name: Cache Miniconda and dependencies
      uses: actions/cache@v1
      with:
        path: /usr/share/miniconda/envs/ci
        key: ${{ runner.OS }}-build-${{ hashFiles('**/requirements.txt') }}

    - name: Set up Python 3.9
      uses: actions/setup-python@v1
      with:
        python-version: '3.9'

    - name: Display system Python3 version
      run: |
        python3 -c 'import sys; print(sys.version)'
        echo "${{ steps.cache.outputs.cache-hit }}"
        pip install python-dateutil

    - name: Set up JDK 1.8 (for Tabula)
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: Set up Conda env 
      run: |
        conda create --name ci -y
        conda init bash

    - name: Install dependencies
      run: |
        source /usr/share/miniconda/etc/profile.d/conda.sh
        conda activate ci
        conda install -c conda-forge mamba
        mamba install -c conda-forge --yes --file requirements.txt
        pip install pytrends
        pip install yfinance==0.1.70
        pip install tika
        pip install unidecode fake_useragent
        #pip install git+https://github.com/abenassi/Google-Search-API
        #pip install git+git://github.com/kulla/Google-Search-API.git@70956914a5e231dd9b65d0b962f8f4b70a899fbf
        rm -rf /usr/share/miniconda/lib/python*/site-packages/selenium*
        mamba install -c conda-forge selenium==3.141.0 --force-reinstall

    - name: Update notebooks
      env:
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
      run: |
        source /usr/share/miniconda/etc/profile.d/conda.sh
        conda activate ci
        find ./analysis/*.ipynb -exec \
          /usr/share/miniconda/envs/ci/bin/jupyter nbconvert \
            --ExecutePreprocessor.timeout=-1 \
            --to notebook --inplace \
            --execute {} \;
        git add ./analysis/*.ipynb

    - name: Commit updated notebooks
      run: |
        git config --local user.email 'action@github.com'
        git config --local user.name 'GitHub Action'
        git commit -m 'Add notebook execution changes'

    - name: Generate webpages
      env:
          GOOGLE_ANALYTICS_TAG_ID: ${{ secrets.GOOGLE_ANALYTICS_TAG_ID }}
      run: |
        source /usr/share/miniconda/etc/profile.d/conda.sh
        conda activate ci
        # Workaround for nbconvert issue 1240
        sed -ie "s/'display_priority.j2'/'base\/display_priority.j2'/g" /usr/share/miniconda/envs/ci/share/jupyter/nbconvert/templates/classic/base.html.j2
        sed -ie "s/'celltags.j2'/'base\/celltags.j2'/g" /usr/share/miniconda/envs/ci/share/jupyter/nbconvert/templates/classic/base.html.j2
        export REPONAME=`echo ${GITHUB_REPOSITORY} | cut -f 1 -d '/'`
        sos run release.sos clean
        sos run release.sos -s force
        git add ./docs

    - name: Commit generated webpages
      run: |
        git config --local user.email 'action@github.com'
        git config --local user.name 'GitHub Action'
        git commit -m 'Add generated page changes'

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
